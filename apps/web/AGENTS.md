# apps/web — Tank Registry

## OVERVIEW

Next.js 15 App Router web app. Public skill registry + protected dashboard + REST API for CLI. PostgreSQL via Drizzle ORM, auth via better-auth (GitHub OAuth + API keys). Supabase for tarball storage only.

## STRUCTURE

```
app/
├── (auth)/              # Login page (GitHub OAuth)
├── (dashboard)/         # Protected: dashboard, tokens, orgs
│   ├── layout.tsx       # Session check → redirect if unauthenticated
│   ├── tokens/          # API key management (server actions)
│   └── orgs/            # Organization CRUD (server actions)
├── (registry)/          # Public: browse & view skills
│   ├── skills/page.tsx  # Search + list all skills
│   └── skills/[...name] # Skill detail (tabs: readme, files, versions, permissions)
├── api/
│   ├── auth/[...all]/   # better-auth catch-all
│   └── v1/              # REST API
│       ├── skills/      # Publish, metadata, download, confirm
│       ├── search/      # Full-text search (PostgreSQL GIN index)
│       └── cli-auth/    # CLI OAuth flow (start, authorize, exchange)
├── cli-login/           # CLI OAuth callback page
├── layout.tsx           # Root layout (Inter font, metadata)
└── page.tsx             # Home page (hero + search + featured skills)

lib/
├── db/
│   ├── schema.ts        # Domain: publishers, skills, skill_versions, skill_downloads, audit_events
│   └── auth-schema.ts   # better-auth generated: user, session, account, apikey, organization, member
├── auth.ts              # better-auth config (GitHub, apiKey plugin, organization plugin)
├── auth-helpers.ts      # verifyCliAuth() — Bearer token → { userId, keyId }
├── auth-client.ts       # Client-side auth helpers
├── cli-auth-store.ts    # In-memory CLI OAuth session store (5-min TTL)
├── db.ts                # Connection singleton (hot-reload safe via globalThis)
├── supabase.ts          # Supabase admin client — STORAGE ONLY, never for DB
├── audit-score.ts       # Compute 0-10 score (pure fn, 8 weighted checks)
├── logger.ts            # Pino → Loki (child loggers: authLog, apiLog, dbLog)
└── utils.ts             # cn() tailwind-merge helper

components/ui/           # shadcn/ui (badge, button, card, dialog, input, label, separator, table, tabs)
api-python/analyze/      # FastAPI security analysis module (Python 3.14)
drizzle/                 # Generated migrations
```

## WHERE TO LOOK

| Task | File | Notes |
|------|------|-------|
| Add API endpoint | `app/api/v1/<name>/route.ts` | Export `GET`/`POST`/`PUT` functions |
| Add page | `app/(<group>)/<name>/page.tsx` | Choose route group |
| Add server action | `app/(<group>)/<name>/actions.ts` | `"use server"` directive |
| Modify DB schema | `lib/db/schema.ts` | Then `drizzle-kit generate` |
| Auth config | `lib/auth.ts` | better-auth plugins and social providers |
| Verify CLI auth | `lib/auth-helpers.ts` | `verifyCliAuth(request)` returns userId or null |
| Add UI component | `components/ui/` | `npx shadcn add <component>` |
| Audit score logic | `lib/audit-score.ts` | Pure function — always returns exactly 8 detail entries |
| Python analysis | `api-python/analyze/` | FastAPI, separate `requirements.txt` |

## CONVENTIONS

- **Route groups**: `(auth)` = login, `(dashboard)` = protected pages, `(registry)` = public browse
- **Auth check**: dashboard `layout.tsx` calls `auth.api.getSession()`, redirects if missing — never in page components
- **API auth split**: CLI endpoints use `verifyCliAuth()` (Bearer token), web pages use session cookies
- **DB connection**: `lib/db.ts` globalThis singleton — never create connections elsewhere
- **Supabase = storage only**: `supabaseAdmin` generates signed URLs for tarball uploads. Never use for DB queries
- **Path alias**: `@/` maps to `apps/web/` root (e.g., `import { db } from '@/lib/db'`)
- **Dual schema files**: `schema.ts` for domain tables, `auth-schema.ts` for better-auth (generated by `@better-auth/cli`)
- **Full-text search**: PostgreSQL `to_tsvector` with GIN index on `skills.name || skills.description`
- **Audit score invariant**: details array is always exactly 8 entries — do not add/remove checks without updating

## ENVIRONMENT VARIABLES

```
DATABASE_URL              # PostgreSQL (Supabase pooler connection string)
SUPABASE_URL              # Supabase project URL
SUPABASE_SERVICE_ROLE_KEY # Supabase admin key (server-only!)
GITHUB_CLIENT_ID          # GitHub OAuth app
GITHUB_CLIENT_SECRET      # GitHub OAuth app
BETTER_AUTH_SECRET        # Session signing secret
NEXT_PUBLIC_APP_URL       # Public URL for OAuth callbacks
```

## ANTI-PATTERNS

- **Never create DB connections outside `lib/db.ts`** — hot-reload safety requires the globalThis singleton
- **Never use Supabase for database queries** — use Drizzle ORM via `lib/db.ts`
- **Never expose `supabaseAdmin` to browser** — service-role key is server-only
- **Never put auth checks in page components** — use layout-level session validation
- **Never import from `apps/cli`** — use `@tank/shared` for shared types
