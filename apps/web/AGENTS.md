# WEB — Next.js 15 Registry

## OVERVIEW

Next.js 15 App Router application serving as the Tank skill registry — web UI, REST API for CLI, and Python security scanning stubs.

## STRUCTURE

```
web/
├── app/
│   ├── layout.tsx                # Root layout
│   ├── page.tsx                  # Homepage
│   ├── cli-login/                # CLI OAuth redirect handler
│   ├── (auth)/login/             # Web login page
│   ├── (dashboard)/              # Protected — layout auth guard
│   │   ├── dashboard/            # Overview
│   │   ├── tokens/               # API key management + actions.ts
│   │   └── orgs/                 # Organization management + actions.ts
│   ├── (registry)/               # Public
│   │   └── skills/[...name]/     # Skill detail (page + tabs + explorer)
│   └── api/v1/                   # REST API (10 endpoints)
│       ├── skills/               # Publish, metadata, download
│       ├── search/               # FTS with GIN index
│       └── cli-auth/             # OAuth start → authorize → exchange
├── api-python/                   # Vercel Python stubs — mirrors python-api/
│   └── analyze/                  # Security scan endpoints
├── lib/
│   ├── db.ts                     # globalThis singleton (hot-reload safe)
│   ├── db/schema.ts              # Domain: skills, versions, downloads, audit, scans
│   ├── db/auth-schema.ts         # better-auth auto-generated tables
│   ├── auth.ts                   # better-auth config (GitHub OAuth + apiKey + org)
│   ├── auth-helpers.ts           # verifyCliAuth() — Bearer token validation
│   ├── cli-auth-store.ts         # In-memory store, 5-min TTL
│   ├── supabase.ts               # Storage client (tarballs only)
│   ├── audit-score.ts            # 0–10 score, 8 weighted checks
│   ├── logger.ts                 # pino → Loki structured logging
│   └── data/skills.ts            # Data access layer
├── components/ui/                # shadcn/ui components (9 files)
└── scripts/                      # Performance testing
    ├── perf-seed.ts              # Seed test data
    ├── perf-analyze-runs.ts      # Analyze results
    └── perf-report.ts            # Generate reports
```

## WHERE TO LOOK

| Task | Location | Notes |
|------|----------|-------|
| Add API endpoint | `app/api/v1/new/route.ts` | Export `GET`/`POST`/etc. |
| Add protected page | `app/(dashboard)/new/page.tsx` | Layout guard handles auth |
| Add public page | `app/(registry)/new/page.tsx` | No auth needed |
| Add server action | `app/(dashboard)/feature/actions.ts` | `'use server'` directive |
| Modify DB schema | `lib/db/schema.ts` | Run `drizzle-kit generate` after |
| Add UI component | `components/ui/` | `npx shadcn add <component>` |
| Auth configuration | `lib/auth.ts` | better-auth plugins: apiKey, organization |
| Modify security scanning | `api-python/analyze/` | Must sync with `python-api/` at root |
| Performance testing | `scripts/perf-*.ts` | Needs real Postgres + Supabase |

## KEY PATTERNS

- **Auth**: Two modes — web sessions (better-auth cookies) and CLI (Bearer `tank_*` API keys)
- **DB singleton**: `globalThis.__db` in `lib/db.ts` — prevents hot-reload connection leaks
- **Dual schema**: `schema.ts` (domain) + `auth-schema.ts` (better-auth generated) — both imported by Drizzle
- **Audit score**: 0–10, always 8 weighted entries (README, LICENSE, permissions, tests, types, examples, size, docs)
- **FTS**: `searchVector` column with GIN index on skills table
- **CLI auth flow**: POST `/cli-auth/start` → redirect to `/cli-auth/authorize` → user grants → POST `/cli-auth/exchange`

## CONVENTIONS

- Server Components by default — `'use client'` only when interactive
- Auth checks at layout level, never in individual pages
- Tailwind CSS v4 via `@tailwindcss/postcss`
- `@/*` import alias (tsconfig paths)
- All data access through `lib/data/skills.ts` or direct Drizzle queries

## ANTI-PATTERNS

- **Never create DB connections outside `lib/db.ts`** — use the globalThis singleton
- **Never use Supabase for DB queries** — Supabase client is for file storage only
- **Never expose `supabaseAdmin` to the browser** — service-role key is server-only
- **Never put auth checks in page components** — layout guards only
- **Never import from `apps/cli`** — use `@tank/shared` for shared types
- **Never modify `auth-schema.ts` manually** — auto-generated by better-auth
